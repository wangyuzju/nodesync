// Generated by CoffeeScript 1.6.3
(function() {
  var CONFIG, fc, fs, init, jch, path, remote, url, watch;

  fs = require('fs');

  url = require('url');

  path = require('path');

  watch = require("watch-project");

  remote = require('./upload');

  fc = require('./filechange');

  CONFIG = require('./config');

  jch = require("jch");

  console.error = function(s) {
    return console.log("\u001b[1;31m" + s + "\u001b[0m");
  };

  console.info = function(s) {
    return console.log("\u001b[36m" + s + "\u001b[0m");
  };

  console.warn = function(s) {
    return console.log("\u001b[35m" + s + "\u001b[0m");
  };

  init = function() {
    var target;
    target = path.resolve(process.argv[2] || "", '.m3dsync_config');
    CONFIG = CONFIG.load(target);
    if (!CONFIG) {
      return;
    }
    if (!fs.existsSync(CONFIG.path)) {
      console.error("Error: ");
      console.log("\tWatching directory '" + CONFIG.path + "' is not Exist!");
      return;
    }
    console.log("Local : >>>");
    console.log("\tWatching   ... '" + CONFIG.path + "'");
    console.log("\tConnecting ... '" + CONFIG.host + "'");
    console.log("");
    remote.connect(CONFIG.host, CONFIG.pathto);
    watch(CONFIG.path, function(e) {
      console.log("Local: >>>\u001b[1;4m" + e.type + "\u001b[0m [" + e.filename + "]");
      console.log("   old:\t" + e.oid);
      console.log("   new:\t" + (e.nid || e.oid));
      switch (e.type) {
        case 'mkdir':
          return remote.mkdir(e.filename);
        case 'change':
        case 'create':
          remote.save(e.filename, e.oid);
          if ((path.basename(e.filename)).slice(0, 3) === 'jch') {
            return jch.parse(e.filename);
          }
          break;
        case 'delete':
        case 'rmdir':
          return remote["delete"](e.filename, e.oid);
        case 'mvfile':
        case 'mvdir':
          return remote.move(e.oname, e.oid, e.filename);
      }
    });
    console.log("done!");
    return process.on('SIGINT', function() {
      return process.exit();
    });
  };

  module.exports.run = init;

}).call(this);
